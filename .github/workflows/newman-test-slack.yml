name: Run Newman Tests and Notify Slack

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  run-newman-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          # Install Node.js and required dependencies
          npm install -g newman newman-reporter-htmlextra

      - name: List files for debugging
        run: ls -al

      - name: Run Newman Tests
        id: newman
        run: |
          newman run DEVVO.postman_collection.json --reporters cli,htmlextra --reporter-htmlextra-export newman-report.json || echo "NEWMAN_FAILED=true" >> $GITHUB_ENV
        continue-on-error: true

      - name: Archive Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: newman-report
          path: newman-report.json

      - name: Extract Failed Requests
        if: env.NEWMAN_FAILED == 'true'
        run: |
          FAILED_REQUESTS=$(jq -r '.run.failures[] | "‚Ä¢ " + .source.name + ": " + .error.message' newman-report.json)
          echo "FAILED_REQUESTS=$FAILED_REQUESTS" >> $GITHUB_ENV

      - name: Notify Slack on Failure
        if: steps.newman.outcome == 'failure'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "Enviando notifica√ß√£o para o Slack com payload formatado"
          curl -X POST "$SLACK_WEBHOOK_URL" \
               -H 'Content-Type: application/json' \
               --data '{"text": "üö® Testes automatizados falharam no reposit√≥rio! As seguintes requisi√ß√µes falharam:\n$FAILED_REQUESTS. Por favor, verifique o relat√≥rio em anexo.", "username": "webhookbot", "icon_emoji": ":ghost:"}'
