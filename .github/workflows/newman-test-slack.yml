name: Run Newman Tests and Notify Slack

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  run-newman-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          # Install Node.js and required dependencies
          npm install -g newman

      - name: List files for debugging
        run: ls -al

      - name: Run Newman Tests
        id: newman
        run: |
          newman run DEVVO.postman_collection.json > newman-output.txt || echo "NEWMAN_FAILED=true" >> $GITHUB_ENV
        continue-on-error: true

      - name: Extract Summary from Newman Output
        if: env.NEWMAN_FAILED == 'true'
        run: |
          TEST_SUMMARY=$(grep -A 90 -B 4 'iterations' newman-output.txt)
          echo "TEST_SUMMARY: $TEST_SUMMARY"
          echo "TEST_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$TEST_SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Notify Slack on Failure
        if: env.NEWMAN_FAILED == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          TEST_SUMMARY: ${{ env.TEST_SUMMARY }}
        run: |
          echo "Enviando notificaÃ§Ã£o para o Slack com payload formatado"
          curl -X POST "$SLACK_WEBHOOK_URL" \
               -H 'Content-Type: application/json' \
               --data "$(jq -n --arg text "ðŸš¨ Testes automatizados falharam no repositÃ³rio! Resumo dos testes:${TEST_SUMMARY}.\nPor favor, verifique os detalhes." '{text: $text, username: "webhookbot", icon_emoji: ":ghost:"}')"
